<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ODORIS - Perfumy Luksusowych Producentów</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* === ZMIENNE KOLORÓW I FONTÓW === */
        :root {
            --color-background-light: #F8F8F4;
            --color-background-dark: #1A1A1A;
            --color-text-dark: #1A1A1A;
            --color-text-light: #F8F8F4;
            --color-accent-gold: #C0A04C;
            --font-serif: 'Playfair Display', serif;
            --font-sans: 'Lato', sans-serif;
        }

        /* === GLOBALNE STYLE === */
        body {
            font-family: var(--font-sans);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            background-color: var(--color-background-dark);
            overflow-x: hidden;
        }
        
        h1, h2, h3, h4 {
            font-family: var(--font-serif);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .gold-text {
            color: var(--color-accent-gold);
            font-weight: 700;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

       /* === PRZEŁĄCZANIE WIDOKÓW === */
        .page-section {
            display: none;
            background-color: var(--color-background-dark); /* <-- ZMIANA TŁA */
            color: var(--color-text-light); /* <-- ZMIANA TEKSTU */
            min-height: 100vh;
        }
        .page-section.active {
            display: block;
        }
        
       /* === Nagłówek i Aktywny Link (dla podstron) === */
        header {
            text-align: center;
            padding: 25px 0;
            /* Złote obramowanie, pasujące do motywu */
            border-bottom: 1px solid rgba(192, 160, 76, 0.3); /* <-- ZMIANA */
            background-color: var(--color-background-dark); /* <-- ZMIANA */
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

       header nav a {
            color: var(--color-text-light); /* <-- ZMIANA */
            text-decoration: none;
            font-size: 13px;
            margin: 0 12px;
            text-transform: uppercase;
            transition: color 0.3s, border-bottom 0.3s;
            cursor: pointer;
        }
        
       /* === NOWY STYL DLA LICZNIKA KOSZYKA === */
        header nav a .cart-counter {
            background-color: var(--color-accent-gold);
            color: var(--color-background-dark);
            border-radius: 50%;
            padding: 0px 5px;
            font-size: 0.8em;
            font-weight: 700;
            min-width: 18px;
            display: inline-block;
            line-height: 18px;
            text-align: center;
            position: relative;
            top: -2px;
        }

        .active-nav-link {
            color: var(--color-accent-gold) !important;
            font-weight: 700;
            border-bottom: 2px solid var(--color-accent-gold);
            padding-bottom: 5px;
        }
        
       /* === SIDE MENU I HAMBURGER === */
        #side-menu {
            height: 100%; width: 0; position: fixed; z-index: 20; top: 0; right: 0;
            background-color: rgba(26, 26, 26, 0.95); overflow-x: hidden; transition: 0.5s;
            padding-top: 60px; color: var(--color-text-light); text-align: center;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.5);
        }
        #side-menu.open { width: 300px; }
        #side-menu a {
            padding: 15px 8px 15px 32px; text-decoration: none; font-size: 18px;
            color: var(--color-text-light); display: block; transition: 0.3s;
            text-transform: uppercase; letter-spacing: 2px; font-family: var(--font-serif);
            cursor: pointer;
        }
        #side-menu a:hover { color: var(--color-accent-gold); background-color: #222; }
        #side-menu .closebtn { position: absolute; top: 0; right: 25px; font-size: 36px; margin-left: 50px; font-weight: 300; }
        
       /* === NOWY STYL DLA LICZNIKA KOSZYKA W SIDE-MENU === */
        #side-menu a .cart-counter {
            background-color: var(--color-accent-gold);
            color: var(--color-background-dark);
            border-radius: 50%;
            padding: 2px 7px;
            font-size: 0.8em;
            font-weight: 700;
            display: inline-block;
            line-height: normal;
        }
        
        /* Globalny styl dla hamburgera */
        .menu-toggle {
            font-size: 30px; cursor: pointer;
            z-index: 15; transition: color 0.3s; line-height: 1;
        }
        /* Hamburger dla Landing Page (Ciemny widok) */
        #landing-page .menu-toggle {
            position: absolute; top: 40px; right: 40px;
            color: var(--color-text-light);
        }
        #landing-page .menu-toggle:hover { color: var(--color-accent-gold); }
        /* Hamburger dla Podstron (Ciemny widok) */
        header .menu-toggle {
            color: var(--color-text-light); /* <-- ZMIANA */
            margin-left: auto;
            padding-right: 15px;
        }
        header .menu-toggle:hover { color: var(--color-accent-gold); }

       /* === STYLE LANDING PAGE === */
        #landing-page {
            background-color: var(--color-background-dark);
            color: var(--color-text-light);
            text-align: center;
            min-height: auto;
        }

       .hero-section {
    /* Używamy publicznego obrazu z internetu jako tła */
    background-image:
        /* Warstwa przyciemniająca (gradient), aby tekst był czytelny */
        linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.8)),
        
        /* Link do obrazu tła (zdjęcie kwiatów i perfum) */
        url('tlo-hero.png');

    /* Ustawiamy pozycjonowanie tła */
    background-size: cover; /* Aby obrazek zawsze pokrywał całą sekcję */
    background-position: center center; /* Aby obrazek był wyśrodkowany */

    /* Reszta Twoich starych stylów (bez zmian) */
    padding: 180px 20px 140px 20px;
    position: relative;

    /* NOWY KOD: Bardzo długie i płynne przejście */
    -webkit-mask-image: linear-gradient(to bottom, black 55%, transparent 100%);
    mask-image: linear-gradient(to bottom, black 55%, transparent 100%);
}
        
        .hero-content h1 { font-size: 4em; letter-spacing: 8px; margin-bottom: 5px; font-weight: 900; }
        .hero-slogan { font-size: 1.2em; margin-bottom: 40px; font-weight: 400; letter-spacing: 3px; }
        .hero-content p { font-family: var(--font-sans); font-size: 1.2em; margin-bottom: 40px; color: rgba(255, 255, 255, 0.9); }
       .btn-main {
            display: inline-block;
            padding: 16px 60px;
            
            /* === NOWE, ZŁOTE STYLE === */
            background-color: #EACD76; /* Jaśniejszy złoty kolor tła */
            color: #332A14; /* Ciemniejszy kolor tekstu dla kontrastu */
            box-shadow: 0 4px 25px rgba(234, 205, 118, 0.6); /* Mocniejszy złoty cień */
            border: 1px solid #D4B76A; /* Ciemniejsza złota ramka */
            /* === KONIEC ZMIAN === */
            
            text-decoration: none;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 2px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .btn-main:hover {
            background-color: transparent;
            color: #EACD76; /* Złoty tekst po najechaniu */
            border: 1px solid #EACD76; /* Złota ramka po najechaniu */
            box-shadow: 0 2px 10px rgba(234, 205, 118, 0.3); /* Delikatniejszy cień */
        }
        
        .values-section, .detail-section { background-color: var(--color-background-dark); color: var(--color-text-light); }
        .values-section { padding: 100px 0; }
        .values-section .value-cards { display: flex; justify-content: space-around; gap: 30px; margin-top: 40px; }
        .values-section .card { flex-basis: 30%; padding: 30px; border: 1px solid rgba(192, 160, 76, 0.3); background-color: #222; }
        .detail-section { padding: 120px 0; }
        .detail-section .content-2col { display: flex; gap: 40px; align-items: flex-start; }
        .detail-section .image-mock { flex: 1; min-height: 400px; border: 4px solid var(--color-accent-gold); box-shadow: 0 0 20px rgba(192, 160, 76, 0.2); background-color: #000; }
        
        /* MINI-FOOTER NA LANDING PAGE */
        .mini-footer { background-color: #101010; color: rgba(255, 255, 255, 0.5); padding: 30px 0; font-size: 0.8em; display: flex; justify-content: space-between; align-items: center; }
        .social-icons a { color: var(--color-text-light); text-decoration: none; font-size: 1.3em; margin: 0 10px; transition: color 0.3s; }
        .social-icons a:hover { color: var(--color-accent-gold); }
        .social-icons span { margin-right: 15px; color: var(--color-accent-gold); font-weight: 700; text-transform: uppercase; font-size: 1em; }
        
        /* ULEPSZONA STOPKA GLOBALNA */
        footer { background-color: #222; color: var(--color-text-light); padding: 40px 0; font-size: 0.85em; }
        .footer-content { display: flex; justify-content: space-between; gap: 30px; }
        .footer-links h4, .footer-contact h4 { color: var(--color-accent-gold); font-size: 1em; margin-top: 0; margin-bottom: 15px; letter-spacing: 1px; }
        .footer-links a { display: block; color: #AAA; text-decoration: none; margin-bottom: 5px; transition: color 0.3s; font-size: 0.9em; cursor: pointer; }
        .footer-links a:hover { color: var(--color-text-light); }
        .footer-contact strong { display: block; margin-top: 10px; font-size: 0.85em; font-weight: 700; }
        .footer-contact a { color: var(--color-text-light); text-decoration: none; font-size: 1.1em; display: inline-block; }
        .copyright { flex-basis: 100%; text-align: center; padding-top: 20px; border-top: 1px solid #333; margin-top: 20px; font-size: 0.75em; color: #666; line-height: 1.4; }

       /* === STYLE DLA CHATBOTA === */
       .chatbot-container {
            background-color: #222; /* <-- ZMIANA */
            border: 1px solid var(--color-accent-gold);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            max-width: 350px;
            margin: 40px auto 0;
            padding: 20px;
            text-align: left;
        }
        .chat-header {
            background-color: var(--color-accent-gold);
            color: var(--color-background-dark);
            padding: 10px;
            margin: -20px -20px 20px -20px;
            font-family: var(--font-serif);
            font-weight: 700;
            text-align: center;
            font-size: 1.2em;
        }
        #chat-history {
            max-height: 250px;
            overflow-y: auto;
            padding-right: 10px;
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }
        .bot-message, .client-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 15px;
            max-width: 80%;
            font-size: 0.9em;
        }
       .bot-message {
            background-color: #333; /* <-- ZMIANA */
            align-self: flex-start;
            border-bottom-left-radius: 2px;
        }
        .client-message {
            background-color: var(--color-accent-gold);
            color: var(--color-background-dark);
            margin-left: auto;
            text-align: right;
            border-bottom-right-radius: 2px;
        }
        .chat-options button {
            display: block;
            width: 100%;
            padding: 10px;
            margin-bottom: 8px;
            border: 1px solid var(--color-accent-gold);
            background-color: transparent;
            color: var(--color-text-dark);
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 700;
        }
        .chat-options button:hover {
            background-color: var(--color-accent-gold);
            color: var(--color-background-dark);
        }
        #chat-input-area {
            display: flex;
            gap: 5px;
            margin-top: 15px;
        }
        #chat-input-area input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #CCC;
        }
        .bot-message a {
            color: var(--color-accent-gold);
            font-weight: 700;
            text-decoration: underline;
            cursor: pointer;
        }
        #chat-input-area button {
            background-color: var(--color-accent-gold);
            color: var(--color-background-dark);
            border: none;
            padding: 10px 15px;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #chat-input-area button:hover {
            background-color: #9E8045;
        }

       /* === STYLE DLA KOLEKCJI === */
        .collection-layout {
            display: flex;
            gap: 30px;
            padding-top: 40px;
        }
        #filter-sidebar {
            flex: 0 0 250px;
            padding: 20px;
            background-color: #222; /* <-- ZMIANA */
            border-right: 1px solid #333; /* <-- ZMIANA */
        
        }
        #filter-sidebar h4 {
            color: var(--color-accent-gold);
            text-transform: uppercase;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1em;
        }
        .filter-group {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #CCC;
        }
        .filter-group label {
            display: block;
            margin-bottom: 8px;
            cursor: pointer;
            font-size: 0.95em;
        }
        #product-list-wrapper {
            flex-grow: 1;
        }
        #sort-options {
            margin-bottom: 20px;
            text-align: right;
        }
        #sort-options label {
            font-weight: 700;
            margin-right: 10px;
        }
        #sort-options select {
            padding: 8px;
            border: 1px solid #AAA;
        }
        #product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 25px;
        }
       .product-card {
            background-color: #222; /* <-- ZMIANA */
            border: 1px solid #333; /* <-- ZMIANA */
            padding: 20px 15px;
            text-align: center;
            transition: box-shadow 0.3s, transform 0.3s;
        }
        .product-card:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-3px);
        }
        .product-card h3 {
            font-family: var(--font-sans);
            font-size: 1.1em;
            font-weight: 700;
           color: var(--color-text-light);
            margin-top: 10px;
            margin-bottom: 5px;
        }
        .product-card .brand {
            font-family: var(--font-serif);
            color: var(--color-accent-gold);
            font-size: 1.3em;
            font-weight: 900;
            margin-bottom: 10px;
        }
        .product-card .price {
            font-size: 1.4em;
            font-weight: 700;
            color: var(--color-accent-gold);
            margin: 10px 0;
        }
        .product-card .btn-add {
            display: block;
            width: 100%;
            padding: 8px;
            background-color: var(--color-text-dark);
            color: var(--color-text-light);
            text-decoration: none;
            text-transform: uppercase;
            font-weight: 700;
            transition: background-color 0.3s;
            cursor: pointer; /* NOWOŚĆ */
            border: none; /* NOWOŚĆ */
            font-family: var(--font-sans); /* NOWOŚĆ */
            font-size: 0.9em; /* NOWOŚĆ */
        }
        .product-card .btn-add:hover {
            background-color: var(--color-accent-gold);
            color: var(--color-text-dark);
        }

       /* === STYLE DLA STRONY KONTA (LOGOWANIE/REJESTRACJA) === */
        #konto-page {
            background-color: var(--color-background-light);
            color: var(--color-text-dark);
            padding-bottom: 0;
        }
        .auth-section {
            padding: 80px 0;
            text-align: center;
        }
        .auth-container {
            display: flex;
            justify-content: center;
            gap: 60px;
            max-width: 1000px;
            margin: 40px auto;
        }
        .auth-form {
           background-color: #252525; /* <-- ZMIANA */
            padding: 40px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            width: 45%;
            text-align: left;
            transition: all 0.3s;
        }
        .auth-form:hover {
             box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        .auth-form h2 {
            text-align: center;
            color: var(--color-accent-gold);
            margin-bottom: 30px;
            font-size: 1.8em;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 400;
            color: var(--color-text-dark);
            font-size: 0.95em;
        }
       .form-group input, .form-group select, .form-group textarea { /* DODANO TEXTAREA */
            width: 100%;
            padding: 12px;
            border: 1px solid #555; /* <-- ZMIANA */
            background-color: #333; /* <-- ZMIANA */
            color: var(--color-text-light); /* <-- ZMIANA */
            font-size: 1em;
            box-sizing: border-box;
            transition: border-color 0.3s;
            font-family: var(--font-sans); /* NOWOŚĆ */
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { /* DODANO TEXTAREA */
            border-color: var(--color-accent-gold);
            outline: none;
            box-shadow: 0 0 5px rgba(192, 160, 76, 0.5);
        }
        .forgot-password {
            font-size: 0.9em;
            text-align: right;
            margin-top: 15px;
        }
        .forgot-password a {
            color: var(--color-text-dark);
            text-decoration: underline;
        }
        .btn-auth {
            display: block;
            width: 100%;
            padding: 14px;
            margin-top: 20px;
            background-color: var(--color-accent-gold);
            color: var(--color-background-dark);
            border: none;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 1px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
       /* === STYLE DLA PANELU UŻYTKOWNIKA === */
        #user-dashboard {
            max-width: 1000px;
            margin: 40px auto;
            padding: 20px;
        }
        .dashboard-header {
            background-color: var(--color-accent-gold);
            color: var(--color-background-dark);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .dashboard-header h2 {
            margin: 0;
            font-size: 1.8em;
        }
        .dashboard-header button {
            background: var(--color-background-dark);
            color: var(--color-accent-gold);
            border: none;
            padding: 10px 20px;
            text-transform: uppercase;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .dashboard-header button:hover {
            background: #444;
        }
        .dashboard-content {
            display: flex;
            gap: 30px;
            margin-top: 30px;
        }
        .dashboard-nav {
            flex: 0 0 220px;
            background-color: #ECECE4;
            padding: 20px;
        }
        .dashboard-nav a {
            display: block;
            padding: 12px 10px;
            text-decoration: none;
            color: var(--color-text-dark);
            border-bottom: 1px dashed #CCC;
            transition: background-color 0.2s, color 0.2s;
            cursor: pointer;
        }
        .dashboard-nav a:hover, .dashboard-nav a.active {
            background-color: var(--color-accent-gold);
            color: var(--color-background-dark);
            font-weight: 700;
        }
        .dashboard-main {
            flex-grow: 1;
            background-color: #FFFFFF;
            padding: 30px;
            border: 1px solid #EEE;
        }
        .order-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .order-table th, .order-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #EEE;
        }
        .order-table th {
            background-color: #F5F5F5;
            color: var(--color-text-dark);
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.85em;
        }

       /* === STYLE DLA PANELU ADMINA (OGÓLNE) === */
        #admin-page .container {
            padding-top: 50px;
            padding-bottom: 50px;
        }
        #admin-page .dashboard-content { /* NOWOŚĆ: Dopasowanie do reszty */
             max-width: 1200px;
             margin: 40px auto;
        }
        /* Style dla formularza i listy produktów (w panelu) */
        .admin-layout {
            display: flex;
            gap: 40px;
            align-items: flex-start;
        }
        .admin-form-container {
            flex: 1;
            padding: 30px;
            background-color: #F0F0F0;
            border: 1px solid rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 120px; /* Wysokość nagłówka + margines */
        }
        .admin-list-container {
            flex: 2;
        }
        .admin-product-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .admin-product-table th, .admin-product-table td {
            padding: 10px;
            border: 1px solid #DDD;
            text-align: left;
            font-size: 0.9em;
        }
        .admin-product-table th {
            background-color: #333;
            color: var(--color-accent-gold);
        }
        .admin-product-table .btn-admin-edit, .admin-product-table .btn-admin-delete {
            padding: 5px 10px;
            border: none;
            cursor: pointer;
            font-size: 0.9em;
            margin-right: 5px;
        }
        .btn-admin-edit {
            background-color: #3498db;
            color: white;
        }
        .btn-admin-delete {
            background-color: #e74c3c;
            color: white;
        }
        .btn-admin-clear {
            background-color: #95a5a6;
            color: #1A1A1A;
            margin-top: 10px;
            padding: 8px;
            border: none;
            cursor: pointer;
            width: 100%;
        }

       /* === NOWE STYLE DLA KART STATYSTYK === */
        .stats-card-container {
            display: flex;
            gap: 20px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }
        .stats-card {
            flex: 1;
            min-width: 200px;
            background-color: #ECECE4;
            padding: 25px;
            border-bottom: 3px solid var(--color-accent-gold);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }
        .stats-card h4 {
            margin: 0 0 10px 0;
            font-size: 1.1em;
            color: #555;
            text-transform: none;
            letter-spacing: 0;
        }
        .stats-card .stat-value {
            font-family: var(--font-serif);
            font-size: 2.5em;
            font-weight: 900;
            color: var(--color-text-dark);
        }

       /* === STYLE DLA STRONY O NAS - SEKACJA DLACZEGO MY === */
        .advantage-section {
            background-color: #ECECE4;
            padding: 60px 0;
            margin-top: 40px;
            border-top: 3px solid var(--color-accent-gold);
        }
        .advantage-list {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            justify-content: center;
            margin-top: 30px;
        }
        .advantage-item {
            background-color: var(--color-background-light);
            border: 1px solid #DDD;
            padding: 25px;
            flex: 1 1 calc(33% - 40px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            min-width: 250px;
            text-align: center;
            transition: transform 0.3s;
        }
        .advantage-item:hover {
             transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }
        .advantage-item h4 {
            color: var(--color-accent-gold);
            font-size: 1.1em;
            margin-top: 0;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }
        .advantage-item .icon {
            font-size: 2em;
            color: var(--color-accent-gold);
            margin-bottom: 10px;
            display: block;
        }

       /* === STYLE DLA PODSTRON Z TEKSTEM (REGULAMIN, POLITYKA, ZWROTY) === */
        .text-page-content {
            padding: 50px 0 80px 0;
            line-height: 1.8;
            font-size: 1.1em;
        }
        .text-page-content h3 {
            color: var(--color-accent-gold);
            margin-top: 40px;
            margin-bottom: 15px;
            font-size: 1.5em;
            letter-spacing: 1px;
            text-transform: none;
        }
        .text-page-content h4 {
            color: var(--color-text-dark);
            margin-top: 25px;
            margin-bottom: 10px;
            font-size: 1.2em;
            letter-spacing: 0.5px;
            text-transform: none;
            font-weight: 700;
        }
        .text-page-content p, .text-page-content ul {
            margin-bottom: 20px;
            color: #AAA; /* <-- ZMIANA */
        }
        .text-page-content ul {
            padding-left: 20px;
            list-style: disc;
        }

       /* === NOWE STYLE DLA KOSZYKA === */
        #koszyk-page .container {
            padding-top: 50px;
            padding-bottom: 80px;
        }
        .koszyk-layout {
            display: flex;
            gap: 40px;
            flex-wrap: wrap;
        }
        #koszyk-lista {
            flex: 2;
            min-width: 300px;
        }
        #koszyk-formularz {
            flex: 1;
            min-width: 300px;
           background-color: #252525; /* <-- ZMIANA */
            padding: 30px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 120px;
        }
        .koszyk-item {
            display: flex;
            gap: 20px;
            align-items: center;
            border-bottom: 1px solid #EEE;
            padding: 20px 0;
        }
        .koszyk-item-img {
            width: 80px;
            height: 80px;
            background-color: #F0F0F0;
            border: 1px solid #DDD;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #AAA;
            font-size: 0.8em;
            text-align: center;
        }
        .koszyk-item-info {
            flex-grow: 1;
        }
        .koszyk-item-info h4 {
            margin: 0;
            font-size: 1.1em;
            font-family: var(--font-sans);
            text-transform: none;
            letter-spacing: 0;
        }
        .koszyk-item-info .brand {
            font-family: var(--font-serif);
            color: var(--color-accent-gold);
            font-weight: 700;
        }
        .koszyk-item-cena {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--color-text-dark);
            min-width: 100px;
            text-align: right;
        }
        .koszyk-ilosc input {
            width: 50px;
            padding: 5px;
            text-align: center;
            border: 1px solid #CCC;
        }
        .btn-usun {
            background: none;
            border: none;
            color: #C00;
            font-size: 1.2em;
            cursor: pointer;
            padding: 5px;
        }
        #koszyk-podsumowanie {
            text-align: right;
            margin-top: 20px;
            border-top: 2px solid #333;
            padding-top: 20px;
        }
        #koszyk-podsumowanie h3 {
            font-size: 1.8em;
            color: var(--color-accent-gold);
            margin: 0;
        }
        #pusty-koszyk-info {
            text-align: center;
            padding: 80px 20px;
            background-color: #F9F9F9;
            border: 1px dashed #CCC;
        }
        #pusty-koszyk-info .btn-main {
            font-size: 1em;
            padding: 12px 30px;
        }
        /* Centrowanie przycisków "Do koszyka" / "Szczegóły" na kartach */
        .product-card > div:last-of-type {
            justify-content: center;
        }

        
        /* 1. Nowy baner "Hero" na stronie kolekcji */
        .collection-hero {
            height: 40vh; /* 40% wysokości ekranu */
            min-height: 300px;
            /* Obraz z inspiracji - zmień na własny jeśli chcesz */
            background-image: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.7)), url('https://i.imgur.com/gYfKXaD.jpeg');
            background-size: cover;
            background-position: center 30%; /* Ustawia ostrość na flakonie */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            margin-bottom: 50px;
            border-bottom: 1px solid rgba(192, 160, 76, 0.5);
        }
        .collection-hero h1 {
            font-size: 3.5em;
            color: var(--color-text-light);
            font-weight: 900;
            margin: 0;
            letter-spacing: 5px;
        }
        .collection-hero p {
            font-size: 1.2em;
            color: var(--color-accent-gold);
            font-family: var(--font-serif);
            font-weight: 400;
            text-transform: none;
            letter-spacing: 1px;
            margin-top: 10px;
        }

        /* 2. Tytuł sekcji (zamiast starego H2) */
        .collection-title {
            font-size: 2.2em;
            text-align: left;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(192, 160, 76, 0.4);
            color: var(--color-text-light);
            text-transform: none; /* Wyłączamy wielkie litery */
            font-weight: 400;
        }
        
        /* 3. Ulepszony Sidebar Filtrów */
        #filter-sidebar {
            background-color: transparent; /* Usuwamy tło */
            border-right: none; /* Usuwamy ramkę */
            padding: 0; /* Usuwamy padding */
            flex: 0 0 220px; /* Zmniejszamy trochę */
        }
        /* Tytuł "FILTRUJ WYNIKI" */
        #filter-sidebar > h4 { 
            color: var(--color-text-light);
            font-size: 1.1em;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--color-accent-gold);
        }

        /* 4. Zmieniony styl sortowania (nad produktami) */
        #sort-options {
            text-align: right;
            margin-bottom: 30px; /* Więcej miejsca */
        }
        #sort-options label {
            color: #AAA;
            font-weight: 400;
            font-size: 0.9em;
        }
        #sort-options select {
            background: var(--color-background-dark);
            color: var(--color-text-light);
            border: 1px solid #555;
            padding: 10px;
            font-family: var(--font-sans);
            font-size: 0.9em;
            cursor: pointer;
        }
        #sort-options select:focus {
             outline: 1px solid var(--color-accent-gold);
        }

        /* 5. Siatka produktów - dodajemy więcej odstępu */
         #product-grid {
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); /* Trochę szersze karty */
            gap: 50px 30px; /* Więcej odstępu (pion/poziom) */
        }

        /* === (KROK 1.B) NAJWAŻNIEJSZE: NOWA KARTA PRODUKTU === */

        .product-card {
            background-color: transparent; /* 1. Usuwamy tło */
            border: none; /* 2. Usuwamy ramkę */
            padding: 0; /* 3. Usuwamy padding */
            text-align: left; /* 4. Wyrównanie do lewej */
            transition: transform 0.3s;
            position: relative; /* Potrzebne dla przycisków */
        }
        .product-card:hover {
            transform: translateY(-5px); /* Lekkie uniesienie */
            box-shadow: none;
        }

        /* Wrapper na zdjęcie (dla hover effect) */
        .product-image-wrapper {
            position: relative;
            background-color: #FFFFFF; /* Jasne tło dla flakonu */
            width: 100%;
            height: 300px; /* Stała wysokość */
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden; /* Ukrywa przyciski */
            transition: background-color 0.3s;
            cursor: pointer;
        }
        .product-image-wrapper .product-image {
             width: 100%;
             height: 100%;
             object-fit: contain; /* Dopasowuje zdjęcie bez zniekształcania */
             transition: transform 0.4s ease-out;
        }
        .product-card:hover .product-image {
            transform: scale(1.05); /* Lekkie powiększenie zdjęcia */
        }

        /* 6. Nowa typografia na karcie */
        .product-card .brand {
            font-family: var(--font-serif);
            color: var(--color-accent-gold);
            font-size: 1.1em;
            font-weight: 400; /* Elegancka, niepogrubiona */
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        .product-card h3 {
            font-family: var(--font-serif);
            font-size: 1.5em; /* Duża, czytelna nazwa */
            font-weight: 400;
            color: var(--color-text-light);
            text-transform: none; /* Bez wielkich liter */
            letter-spacing: 0.5px;
            margin-top: 0;
            margin-bottom: 10px;
            line-height: 1.3;
        }
        .product-card .price {
            font-family: var(--font-sans);
            font-size: 1.2em;
            font-weight: 700;
            color: var(--color-text-light); /* Jaśniejsza cena */
            margin: 10px 0;
        }

        /* 7. Ukryte przyciski (pojawiające się na hover) */
        .product-buttons-wrapper {
            opacity: 0; /* Domyślnie ukryte */
            transition: opacity 0.3s ease-out;
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        .product-card:hover .product-buttons-wrapper {
            opacity: 1; /* Pokaż na hover */
        }

        /* 8. Nowy styl przycisków na karcie */
        .product-card .btn-add {
            display: block;
            width: auto; /* Dopasuj do treści */
            flex-grow: 1; /* Rozciągnij główny przycisk */
            padding: 12px 10px;
            background-color: var(--color-accent-gold); /* Złoty przycisk */
            color: var(--color-background-dark); /* Ciemny tekst */
            text-decoration: none;
            text-transform: uppercase;
            text-align: center;
            font-weight: 700;
            transition: all 0.3s;
            cursor: pointer;
            border: 1px solid var(--color-accent-gold);
            font-family: var(--font-sans);
            font-size: 0.9em;
        }
        .product-card .btn-add:hover {
            background-color: transparent;
            color: var(--color-accent-gold);
            border-color: var(--color-accent-gold);
        }
        
        /* Przycisk "Szczegóły" (drugi) */
        .product-card .btn-details {
            display: block;
            width: auto;
            flex-grow: 0;
            padding: 12px 15px;
            background: transparent;
            color: var(--color-text-light);
            border: 1px solid #555;
            font-size: 0.9em;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s;
        }
         .product-card .btn-details:hover {
            border-color: var(--color-accent-gold);
            color: var(--color-accent-gold);
         }
        
        /* === KONIEC ZMIAN: KROK 1 === */
        
        
        /* === RESPONSIVE DESIGN (MEDIA QUERIES) === */
        @media (max-width: 1024px) {
            header nav { display: none; }
            .footer-content { flex-wrap: wrap; justify-content: space-around; }
            .footer-links, .footer-contact { flex-basis: 45%; margin-bottom: 30px; }
            .collection-layout { flex-direction: column; }
            #filter-sidebar {
                flex: 1 1 100%;
                border-right: none;
                border-bottom: 1px solid rgba(192, 160, 76, 0.4); /* Złota linia */
                padding: 0 0 20px 0; /* Padding tylko na dole */
            }
            #product-grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); } /* Lepsza siatka na tablet */
            .dashboard-content { flex-direction: column; }
            .dashboard-nav { flex: 1 1 100%; }
            .admin-layout { flex-direction: column; }
            .admin-form-container { position: static; }
            #koszyk-formularz { position: static; } /* NOWOŚĆ */
        }

       @media (max-width: 768px) {
    .hero-section { 
        padding: 120px 15px 80px 15px; 
        background-position: 85% center; /* To przesunie obrazek, żeby butelka była widoczna */
    }
}
            .values-section .value-cards { flex-direction: column; gap: 20px; }
            .values-section .card { flex-basis: 100%; padding: 20px; }
            .detail-section .content-2col { flex-direction: column; gap: 30px; }
            .detail-section .image-mock { display: none; }
             .footer-links, .footer-contact { flex-basis: 100%; text-align: center; }
            .footer-links a { display: inline-block; margin: 0 10px 5px 10px; }
            .auth-container { flex-direction: column; gap: 30px; }
            .auth-form { width: 100%; box-sizing: border-box; }
             #pomoc-page .container > div { flex-direction: column; }
             .chatbot-container { max-width: 100%; }
             .advantage-list { flex-direction: column; gap: 20px; }
            .advantage-item { flex: 1 1 100%; }
            .dashboard-header { flex-direction: column; text-align: center; gap: 10px; }
            .stats-card-container { flex-direction: column; } /* NOWOŚĆ */
            /* === POPRAWKI MOBILNE (PRODUKTY I NAGŁÓWEK) === */
        
            /* 1. Zmniejszenie nagłówka na wszystkich podstronach */
            header {
                /* Zmniejszamy padding (wysokość) nagłówka */
                padding: 12px 0;
            }

            header h1 {
                /* Zmniejszamy logo/tytuł w nagłówku.
                   Używamy !important, aby pokonać styl inline (font-size: 2.5em) z HTML */
                font-size: 1.9em !important;
            }

            /* 2. Poprawki siatki produktów (styl "Sephora") */
            #product-grid {
                /* Wymuszamy 2 kolumny na telefonie */
                grid-template-columns: repeat(2, 1fr);
                gap: 30px 15px; /* Zmniejszamy odstęp boczny */
            }
            
            /* NOWOŚĆ: Poprawki dla szerszej karty na mobilce */
            .product-image-wrapper {
                height: 220px; /* Niższe zdjęcia na mobilce */
            }
             .product-card h3 {
                font-size: 1.1em; /* Mniejsza czcionka nazwy */
                line-height: 1.3;
             }
             .product-card .price {
                font-size: 1.1em; /* Mniejsza czcionka ceny */
             }
            /* Ukrywamy przyciski na mobilce, aby oszczędzić miejsce */
            .product-buttons-wrapper {
                display: none;
            }
            /* Zamiast tego, pokazujemy je na hover (na desktopie) LUB zostawiamy ukryte na mobilce */
            /* (Poprzednie style .product-card:hover .product-buttons-wrapper załatwiają sprawę na desktopie) */


            /* Poprawka dla kontenera na mobilkach, aby mieć padding */
            .container {
                padding: 0 15px;
            }
        /** ZAKTUALIZOWANA: Renderuje statystyki i listę zamówień z Supabase */
          async function renderAdminStatsAndOrders() {
             
             // 1. ZACIĄGNIJ DANE Z SUPABASE (zamiast getOrdersFromStorage())
             const { data: orders, error } = await supabase
                 .from('zamowienia')
                 .select('*')
                 .order('created_at', { ascending: false }); // Sortuj od najnowszych

             if (error) {
                 console.error("Błąd pobierania zamówień z Supabase:", error.message);
                 alert("Nie udało się pobrać listy zamówień. Sprawdź konsolę F12.");
             }

             // Użyj 'orders' z Supabase lub pustej tablicy, jeśli jest błąd
             const allOrders = orders || []; 

             // 2. Oblicz statystyki (używamy teraz nazw kolumn z bazy danych)
             const totalRevenue = allOrders.reduce((sum, order) => sum + (order.total_price || 0), 0);
             const totalOrders = allOrders.length;

             // 3. Wypełnij karty statystyk
             document.getElementById('stats-total-revenue').textContent = totalRevenue.toFixed(2) + ' PLN';
             document.getElementById('stats-total-orders').textContent = totalOrders;
             
             // 4. Wypełnij tabelę zamówień
             const listBody = document.getElementById('admin-orders-list-body');
             if (!listBody) return;
             listBody.innerHTML = '';

             if (allOrders.length === 0) {
                 listBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Brak zamówień w bazie.</td></tr>';
                 return;
             }

             // 5. ZMAPUJ NOWE DANE DO TABELI
             allOrders.forEach(order => {
                 const statusColor = order.status === 'Dostarczono' ? '#0A0' : order.status === 'Wysłano' ? '#F90' : (order.status === 'Oczekuje' ? '#C00' : '#888');
                 
                 // Sformatuj datę (z '2025-11-06T19:55:30+00:00' na '06.11.2025')
                 const orderDate = new Date(order.created_at).toLocaleDateString('pl-PL'); 
                 
                 // Sformatuj listę przedmiotów (z JSON na tekst)
                 let itemsText = 'Brak danych';
                 if (Array.isArray(order.items) && order.items.length > 0) {
                     itemsText = order.items.map(item => `${item.name} (x${item.quantity})`).join(', ');
                 }

                 listBody.innerHTML += `
                     <tr>
                         <td>${order.id.substring(0, 8)}...</td> 
                         <td>${orderDate}</td>
                         <td>${order.customer_email}</td>
                         <td>${itemsText}</td>
                         <td>${(order.total_price || 0).toFixed(2)} PLN</td>
                         <td><strong style="color: ${statusColor};">${order.status}</strong></td>
                     </tr>
                 `;
             });
         }

         /** Renderuje listę produktów w tabeli admina (teraz wywoływane przez showAdminContent) */
         function renderAdminProductList() {
             const listBody = document.getElementById('admin-product-list-body');
             if (!listBody) return;
             
             const products = getProductsFromStorage();
             listBody.innerHTML = ''; 

             if (products.length === 0) {
                 listBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Brak produktów w bazie.</td></tr>';
                 return;
             }

             products.forEach(p => {
                 listBody.innerHTML += `
                     <tr>
                         <td>${p.id}</td>
                         <td>${p.brand}</td>
                         <td>${p.name}</td>
                         <td>${p.price} PLN</td>
                         <td>${p.category}</td>
                         <td>
                             <button class="btn-admin-edit" onclick="populateAdminForm('${p.id}')">Edytuj</button>
                             <button class="btn-admin-delete" onclick="deleteProduct('${p.id}')">Usuń</button>
                         </td>
                     </tr>
                 `;
             });
         }

         /** Obsługuje wysłanie formularza admina (Dodawanie lub Edycja) */
         function handleAdminFormSubmit(event) {
             event.preventDefault();
             
             const productId = document.getElementById('admin-product-id').value;
             
             const productData = {
                 brand: document.getElementById('admin-brand').value,
                 name: document.getElementById('admin-name').value,
                 price: parseInt(document.getElementById('admin-price').value, 10),
                 category: document.getElementById('admin-category').value,
                 description: document.getElementById('admin-description').value,
                 specs: readSpecsFromForm(),
                 images: adminImageData.slice()
             };

             if (productId) {
                 // === TRYB EDYCJI ===
                 let products = getProductsFromStorage();
                 const updatedProducts = products.map(p => {
                     if (String(p.id) === String(productId)) { // Poprawka String()
                         return { ...p, ...productData, id: p.id }; // Zachowaj oryginalne ID
                     }
                     return p;
                 });
                 saveProductsToStorage(updatedProducts);
                 alert('Produkt zaktualizowany!');

            } else {
                 // === TRYB DODAWANIA ===
                 let products = getProductsFromStorage();
                 const newProduct = {
                     ID: Date.now(), // <-- POPRAWKA: Duże ID i jest liczbą
                     ...productData
                 };
                 products.push(newProduct);
                 saveProductsToStorage(products);
                 alert('Nowy produkt dodany!');
             }

             clearAdminForm();
             renderAdminProductList();
             applyFilters(); // NOWOŚĆ: Odśwież też widok sklepu
         }

         /** Wypełnia formularz admina danymi do edycji */
         function populateAdminForm(productId) {
             const products = getProductsFromStorage();
             const productToEdit = products.find(p => String(p.id) === String(productId)); // Poprawka String()
             if (!productToEdit) return;

             document.getElementById('admin-product-id').value = productToEdit.id;
             document.getElementById('admin-brand').value = productToEdit.brand;
             document.getElementById('admin-name').value = productToEdit.name;
             document.getElementById('admin-price').value = productToEdit.price;
             document.getElementById('admin-category').value = productToEdit.category;
             
             document.getElementById('admin-description').value = productToEdit.description || '';
             setSpecsToForm(productToEdit.specs || []);
             
             // Załaduj obrazy produktu do formularza admina (edycja)
             adminImageData = (productToEdit.images && productToEdit.images.slice()) || [];
             renderAdminImagePreviews();
             
             document.getElementById('admin-form-title').textContent = 'Edytuj Produkt (ID: ' + productToEdit.id + ')';
             
             // Przewiń do formularza
             const formContainerEl = document.getElementById('admin-form-container');
             if (formContainerEl) {
                 window.scrollTo({ top: formContainerEl.offsetTop - 100, behavior: 'smooth' });
             }
         }

         /** Czyści formularz admina */
         function clearAdminForm() {
             const form = document.getElementById('admin-product-form');
             if (form) form.reset();
             document.getElementById('admin-product-id').value = '';
             document.getElementById('admin-form-title').textContent = 'Dodaj Nowy Produkt';
             const specsList = document.getElementById('admin-specs-list');
             if (specsList) specsList.innerHTML = '';

             // Czyść obrazy w formularzu
             adminImageData = [];
             const inputFile = document.getElementById('admin-images');
             if (inputFile) inputFile.value = '';
             const preview = document.getElementById('admin-image-previews');
             if (preview) preview.innerHTML = '';
         }


         function deleteProduct(productId) {
             if (!confirm('Czy na pewno chcesz trwale usunąć ten produkt? Tej akcji nie można cofnąć.')) {
                 return;
             }

             let products = getProductsFromStorage();
             const filteredProducts = products.filter(p => String(p.id) !== String(productId)); // Poprawka String()
             
             // Zapisz zmienioną listę do LocalStorage
             localStorage.setItem(LS_PRODUCTS_KEY, JSON.stringify(filteredProducts));
             
             // NOWOŚĆ: Usuń również z Supabase
             deleteProductFromSupabase(productId); 
             
             alert('Produkt usunięty.');
             renderAdminProductList(); 
             applyFilters(); // Odśwież widok sklepu
         }

         // --- FUNKCJE NAWIGACJI ---
         // (ZAKTUALIZOWANA FUNKCJA)
         function highlightNavLink(activePageId, activeSectionElement) {
             // Krok 1: Znajdź nawigację <nav> TYLKO wewnątrz aktywnej sekcji
             // To jest kluczowa poprawka - szukamy tylko w widocznym nagłówku
             const headerNav = activeSectionElement.querySelector('header nav');
             
             // Jeśli strona nie ma nawigacji (np. strona produktu), wyjdź
             if (!headerNav) {
                 return; 
             }

             // Krok 2: Wyczyść wszystkie linki w TYM KONKRETNYM pasku nawigacji
             const allNavLinks = headerNav.querySelectorAll('a');
             allNavLinks.forEach(link => { link.classList.remove('active-nav-link'); });

             // Krok 3: Znajdź prefix ID linku, który ma być aktywny
             // (Ta logika była poprawna)
             let targetIdPrefix;
             if (activePageId.includes('kolekcja')) { targetIdPrefix = 'link-kolekcja'; } 
             else if (activePageId.includes('onas')) { targetIdPrefix = 'link-onas'; } 
             else if (activePageId.includes('regulamin')) { targetIdPrefix = 'link-regulamin'; } 
             else if (activePageId.includes('polityka')) { targetIdPrefix = 'link-polityka'; } 
             else if (activePageId.includes('zwroty')) { targetIdPrefix = 'link-zwroty'; } 
             else if (activePageId.includes('pomoc')) { targetIdPrefix = 'link-pomoc'; }
             else if (activePageId.includes('konto')) { targetIdPrefix = 'link-konto'; }
             else if (activePageId.includes('koszyk')) { targetIdPrefix = 'link-koszyk'; } 
             
             if (targetIdPrefix) {
                 // Krok 4: Znajdź DOKŁADNY link w aktywnym pasku nawigacji
                 // Na stronie "O Nas" (onas-page), szukamy linku o ID "link-onas"
                 // Na stronie "Kolekcja" (kolekcja-page), szukamy linku o ID "link-kolekcja"
                 const exactLinkToHighlight = headerNav.querySelector(`#${targetIdPrefix}`);
                 
                 if (exactLinkToHighlight) {
                     exactLinkToHighlight.classList.add('active-nav-link');
                 } else {
                     // Drobna poprawka na wypadek, gdyby ID linków były różne (np. link-kolekcja-onas)
                     // Spróbuj znaleźć link, który zaczyna się od prefixu
                     const firstTry = headerNav.querySelector(`[id^="${targetIdPrefix}"]`);
                     if(firstTry) {
                         firstTry.classList.add('active-nav-link');
                     }
                 }
             }
         }

         function scrollToElement(elementId) {
             const element = document.getElementById(elementId);
             if (element) { setTimeout(() => { element.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 100); }
         }

         function showPageAndScroll(pageId, elementId) {
             showPage(pageId);
             scrollToElement(elementId);
             // Ta linijka poniżej jest teraz zbędna, bo showPage() samo wywoła highlightNavLink
             // const targetPageId = pageId.split('-')[0];
             // highlightNavLink(targetPageId);
         }

         function openNav() { document.getElementById("side-menu").classList.add("open"); }
         function closeNav() { document.getElementById("side-menu").classList.remove("open"); }
         
         /** Główna funkcja nawigacyjna - z kontrolą dostępu (ZAKTUALIZOWANA) */
         function showPage(pageId) {
             // === KONTROLA DOSTĘPU ADMINA ===
             if (pageId === 'admin-page' && !isCurrentUserAdmin()) {
                 alert('Nie masz uprawnień do tej strony. Zaloguj się jako administrator.');
                 showPage(getIsLoggedIn() ? 'konto-page' : 'landing-page');
                 return;
             }
             // === KONTROLA DOSTĘPU KLIENTA ===
             if (pageId === 'konto-page' && isCurrentUserAdmin()) {
                 pageId = 'admin-page';
             }

             


             const sections = document.querySelectorAll('.page-section');
             sections.forEach(section => { section.classList.remove('active'); });
             
             // === ZMIANA ===
             // Pobieramy element sekcji, aby przekazać go do funkcji podświetlającej
             const activeSection = document.getElementById(pageId); 
             // === KONIEC ZMIANY ===

             if (activeSection) {
                 activeSection.classList.add('active');
                 const event = new CustomEvent('pageShow', { detail: { pageId: pageId } });
                 document.dispatchEvent(event);
             } else {
                 document.getElementById('landing-page').classList.add('active');
                 return;
             }
             
             if (pageId !== 'landing-page') { 
                 // === ZMIANA ===
                 // Przekazujemy teraz ID strony ORAZ element aktywnej sekcji
                 highlightNavLink(pageId, activeSection); 
                 // === KONIEC ZMIANY ===
             } else { 
                 document.querySelectorAll('header nav a').forEach(link => { link.classList.remove('active-nav-link'); }); 
             }
             
             window.scrollTo({ top: 0, behavior: 'smooth' });

             // Inicjalizuj odpowiednie strony
             if (pageId === 'kolekcja-page') {
                 applyFilters(); 
             }
             if (pageId === 'konto-page') {
                 renderKontoPage();
             }
             if (pageId === 'admin-page') {
                 renderAdminPage(); 
             }
             // ### KROK 3: DODANIE WYWOŁANIA RENDEROWANIA KOSZYKA ###
             if (pageId === 'koszyk-page') {
                 renderCartPage();
             }
         }

         // --- LOGIKA KONT (PANEL KLIENTA) ---
         function renderKontoPage() {
             const kontoContent = document.getElementById('konto-content');
             if (!kontoContent) return;

             kontoContent.innerHTML = ''; 
             
             if (getIsLoggedIn() && !isCurrentUserAdmin()) {
                 const template = document.getElementById('dashboard-template');
                 const clone = document.importNode(template.content, true);
                 kontoContent.appendChild(clone);
                 
                 document.getElementById('user-name-display').textContent = getUserName();
                 showDashboardContent('orders');
             } else {
                 const template = document.getElementById('auth-template');
                 const clone = document.importNode(template.content, true);
                 kontoContent.appendChild(clone);
             }
         }
         
         // ZMODYFIKOWANE: Używamy teraz bazy `pf_orders` zamiast `mockOrders`
         function showDashboardContent(view) {
             const mainContent = document.getElementById('dashboard-main');
             const navLinks = document.querySelectorAll('#user-dashboard .dashboard-nav a');
             
             navLinks.forEach(link => link.classList.remove('active'));
             const activeNav = document.getElementById(`nav-${view}`);
             if(activeNav) activeNav.classList.add('active');

             if (!mainContent) return;
             mainContent.innerHTML = '';
             
             if (view === 'orders') {
                 const currentUserEmail = getCurrentUser().email;
                 // Filtruj zamówienia tylko dla zalogowanego klienta
                 const userOrders = getOrdersFromStorage().filter(order => order.email === currentUserEmail);

                 let tableHTML = `
                     <h3>Historia Twoich Zamówień</h3>
                     <p>Poniżej znajdziesz listę wszystkich swoich transakcji.</p>
                     <table class="order-table">
                         <thead>
                             <tr>
                                 <th>Numer</th>
                                 <th>Data</th>
                                 <th>Produkt</th>
                                 <th>Wartość</th>
                                 <th>Status</th>
                             </tr>
                         </thead>
                         <tbody>
                 `;
                 if (userOrders.length > 0) {
                     userOrders.forEach(order => {
                         const statusColor = order.status === 'Dostarczono' ? '#0A0' : order.status === 'Wysłano' ? '#F90' : '#C00';
                         tableHTML += `
                             <tr>
                                 <td>${order.id}</td>
                                 <td>${order.date}</td>
                                 <td>${order.items}</td>
                                 <td>${(order.total || 0).toFixed(2)} PLN</td>
                                 <td><strong style="color: ${statusColor};">${order.status}</strong></td>
                     </tr>
                         `;
                     });
                 } else {
                     tableHTML += '<tr><td colspan="5" style="text-align: center;">Nie złożyłeś jeszcze żadnego zamówienia.</td></tr>';
                 }
                 tableHTML += `</tbody></table>`;
                 mainContent.innerHTML = tableHTML;

             } else if (view === 'address') {
                 mainContent.innerHTML = `
                     <h3>Adresy Dostawy</h3>
                     <p>Główny adres:</p>
                     <div style="border: 1px solid #CCC; padding: 15px; margin-bottom: 20px;">
                         <strong>${getUserName()} Kowalski</strong><br>
                         ul. Elegancka 5/8<br>
                         01-234 Warszawa<br>
                         Tel: 555 666 777
                     </div>
                     <button class="btn-main" style="width: auto; padding: 10px 20px;">Edytuj Adres</button>
                 `;
             } else if (view === 'profile') {
                 mainContent.innerHTML = `
                     <h3>Edycja Danych Profilowych</h3>
                     <p>Możesz zmienić swoje dane osobowe oraz hasło.</p>
                     <form onsubmit="alert('Dane profilowe zostały zaktualizowane (symulacja)!'); return false;">
                         <div class="form-group" style="margin-bottom: 15px;">
                             <label>Nazwa użytkownika</label>
                             <input type="text" value="${getUserName()}" required>
                         </div>
                         <div class="form-group" style="margin-bottom: 15px;">
                             <label>Adres E-mail</label>
                             <input type="email" value="${getCurrentUser().email}" required>
                         </div>
                         <button type="submit" class="btn-main" style="width: auto; padding: 10px 20px;">Zapisz Zmiany</button>
                     </form>
                 `;
             }
         }

         // --- LOGIKA KOLEKCJI (FRONTEND) ---

         function renderProducts(products) {
             const grid = document.getElementById('product-grid');
             if (!grid) return; 
             
             const noProducts = document.getElementById('no-products'); 
             grid.innerHTML = ''; 
             
             if (products.length === 0) {
                 if (noProducts) {
                     noProducts.style.display = 'block';
                     grid.appendChild(noProducts); 
                 }
                 return;
             }
             if (noProducts) noProducts.style.display = 'none';

             products.forEach(product => {
                 const card = document.createElement('div');
                 card.className = 'product-card';
                 
                 // === (KROK 3.A) ZAKTUALIZOWANY KOD KARTY PRODUKTU ===
                 // Używamy nowych klas CSS zdefiniowanych w Kroku 1
                 card.innerHTML = `
                     <div class="product-image-wrapper" onclick="showProductDetail('${product.id}')">
                         <img src="${(product.images && product.images[0]) ? product.images[0] : 'https://via.placeholder.com/300x400.png?text=Brak+Zdjecia'}" 
                              alt="${product.name}" 
                              class="product-image">
                     </div>
                     
                     <div class="brand">${product.brand}</div>
                     <h3 onclick="showProductDetail('${product.id}')" style="cursor: pointer;">${product.name || 'Brak Nazwy'}</h3>
                     <div class="price">${product.price} PLN</div>

                     <div class="product-buttons-wrapper">
                         ${product.id ?
                             `
                             <button class="btn-add" onclick="addToCart('${product.id}')">Do koszyka</button>
                             <button class="btn-details" onclick="showProductDetail('${product.id}')">Info</button>
                             ` :
                             `
                             <button class="btn-add" style="background:#CCC; color:#666;" disabled>DO KOSZYKA</button>
                             <button class="btn-details" style="background:transparent; color:#CCC; border:1px solid #CCC;" disabled title="Produkt chwilowo niedostępny (brak ID)">Info</button>
                             `
                         }
                     </div>
                 `;
                 // === KONIEC ZAKTUALIZOWANEGO KODU KARTY ===
                 
                 grid.appendChild(card);
             });
         }
         function applyFilters() {
             let filteredProducts = getProductsFromStorage();
             
             const selectedBrands = Array.from(document.querySelectorAll('#filter-sidebar input[data-filter="brand"]:checked')).map(cb => cb.value);
             const selectedCategories = Array.from(document.querySelectorAll('#filter-sidebar input[data-filter="category"]:checked')).map(cb => cb.value);
             
             if (selectedBrands.length > 0) {
                 filteredProducts = filteredProducts.filter(p => selectedBrands.includes(p.brand));
            }
             
             if (selectedCategories.length > 0) {
                 filteredProducts = filteredProducts.filter(p => selectedCategories.includes(p.category));
             }
             
             const sortByElement = document.getElementById('sort-by');
            if(sortByElement) {
                 const sortBy = sortByElement.value;
                 if (sortBy === 'price-asc') {
                     filteredProducts.sort((a, b) => a.price - b.price);
                 } else if (sortBy === 'price-desc') {
                     filteredProducts.sort((a, b) => b.price - a.price);
                 }
            }
             
             renderProducts(filteredProducts);
         }
         
         // --- NOWA LOGIKA CHATBOTA (v2 - Stanowa, Multi-intent, Supabase) ---

         // Definicje intencji i słów kluczowych
         const chatIntents = {
             GREETING: ['czesc', 'witaj', 'dzien dobry', 'hej', 'siema'],
             ORDER_STATUS: ['zamowienie', 'status', 'sledzenie', 'gdzie jest', 'paczka'],
             DELIVERY_INFO: ['dostawa', 'wysylka', 'czas', 'kurier', 'ile trwa'],
             ORIGINALITY_GUARANTEE: ['oryginalnosc', 'podrobka', 'gwarancja', 'autentycznosc', 'pewnosc'],
             RETURNS_COMPLAINTS: ['zwrot', 'reklamacja', 'uszkodzony', 'opakowanie', 'zepsuty'],
             PRODUCT_INFO: ['cena', 'kosztuje', 'jaki', 'zapach', 'dostepny', 'kupic'],
             CHANGE_ADDRESS: ['zmienic miejsce', 'zmienic adres', 'inny adres', 'miejsce odbioru'],
             CONTACT: ['kontakt', 'telefon', 'email', 'rozmowa', 'konsultant']
         };

         // Baza odpowiedzi
         const chatResponses = {
             GREETING: 'Cześć! W czym mogę Ci pomóc? Możesz zapytać o status zamówienia, gwarancję oryginalności lub zwroty.',
             ORDER_STATUS: 'Rozumiem, że chcesz sprawdzić status zamówienia. Proszę, podaj mi jego numer (np. 2025/10/29).',
             DELIVERY_INFO: 'Wysyłka w **ODORIS** jest realizowana zazwyczaj w ciągu <b>24 godzin</b>. Korzystamy z zaufanych kurierów (DPD/Inpost). Czas dostawy to standardowo 1-2 dni robocze. Chcesz dowiedzieć się więcej o <a onclick="showPage(\'regulamin-page\');">warunkach dostawy</a>?',
             ORIGINALITY_GUARANTEE: 'Wszystkie produkty są <b>100% oryginalne</b> i pochodzą bezpośrednio od autoryzowanych dystrybutorów. Gwarantujemy to naszą <a onclick="showPage(\'onas-page\');">Misją i Filozofią</a>.',
             RETURNS_COMPLAINTS: 'Pamiętaj, że ze względu na higienę, przyjmujemy zwroty w ciągu 14 dni tylko dla flakonów <b>z nienaruszoną plombą/folią fabryczną</b>. Szczegóły znajdziesz na stronie <a onclick="showPage(\'zwroty-page\');">Zwroty i Reklamacje</a>.',
             CHANGE_ADDRESS: 'Jeśli chodzi o zmianę miejsca odbioru lub adresu dostawy, jest to możliwe tylko <b>przed nadaniem paczki</b>. Proszę o pilny, bezpośredni kontakt z Biurem Obsługi Klienta pod numerem **532 116 720**.',
             CONTACT: 'Jeśli potrzebujesz bezpośredniego kontaktu z konsultantem, zadzwoń pod numer **532 116 720** (Pon-Pt, 9:00-17:00) lub napisz na <b>odoris.pl@gmail.com</b>.',
             PRODUCT_INFO_GENERIC: 'Informacje o cenie i dostępności danego produktu (np. Tom Ford, Creed) znajdziesz w naszym <a onclick="showPage(\'kolekcja-page\');">katalogu Kolekcji</a>. Użyj filtrów, aby znaleźć to, czego szukasz.',
             DEFAULT: 'Przepraszam, nie jestem pewien, jak Ci pomóc w tej kwestii. Jako AI, najlepiej radzę sobie z pytaniami o: <b>status zamówienia</b>, <b>wysyłkę</b>, <b>oryginalność</b> i <b>zwroty</b>. Czy możesz przeformułować swoje pytanie?',
             THANKS: 'Cieszę się, że mogłem pomóc! Czy masz jeszcze jakieś pytania?'
         };
         
         /** Dodaje wiadomość do historii czatu */
         function addMessage(text, type, id = null) {
             const history = document.getElementById('chat-history');
             if (!history) return;
             const msgDiv = document.createElement('div');
             msgDiv.className = type + '-message';
             msgDiv.innerHTML = text;
             if (id) {
                 msgDiv.id = id;
             }
             history.appendChild(msgDiv);
             history.scrollTop = history.scrollHeight;
             return msgDiv; // Zwróć element, aby móc go edytować (np. "pisze...")
         }
         
         /** Aktualizuje istniejącą wiadomość bota (np. usuwa "pisze...") */
         function updateMessage(element, newText) {
             if (element) {
                 element.innerHTML = newText;
                 element.classList.remove('typing');
             }
         }
         
         /** Wyświetla domyślne opcje na przyciskach */
         function displayDefaultOptions() {
             const optionsDiv = document.getElementById('chat-options');
             if (!optionsDiv) return;
             optionsDiv.innerHTML = `
                 <button onclick="handleOptionClick('Jaki jest status zamówienia?')">Status zamówienia</button>
                 <button onclick="handleOptionClick('Jak mogę zwrócić produkt?')">Zwroty i Reklamacje</button>
                 <button onclick="handleOptionClick('Czy perfumy są oryginalne?')">Gwarancja oryginalności</button>
                 <button onclick="handleOptionClick('Kontakt z konsultantem')">Kontakt</button>
             `;
             optionsDiv.style.display = 'block';
         }
         
         /** Obsługuje kliknięcie na przycisk opcji */
         function handleOptionClick(message) {
             const inputElement = document.getElementById('user-input');
             inputElement.value = message;
             sendChatMessage();
         }

         /** Główna funkcja wysyłająca wiadomość (teraz asynchroniczna) */
         async function sendChatMessage() {
             const inputElement = document.getElementById('user-input');
             const message = inputElement.value.trim();
             if (message === '') return;

             addMessage(message, 'client');
             inputElement.value = '';
             document.getElementById('chat-options').style.display = 'none';
             toggleChatInput(false); // Zablokuj input

             // Pokaż "Bot pisze..."
             const typingMsg = addMessage("...", 'bot typing');
             await new Promise(r => setTimeout(r, 800)); // Symulacja namysłu

             let response;
             
           // SPRAWDZENIE STANU ROZMOWY
             if (chatState === 'AWAITING_ORDER_NUMBER') {
                 response = await fetchOrderStatus(message);
             } else {
                 response = generateBotResponse(message);
             }
             
             // Aktualizuj wiadomość "pisze..." na pełną odpowiedź
             updateMessage(typingMsg, response.text);
             chatState = response.newState; // Ustaw nowy stan

             // Jeśli wracamy do stanu IDLE, pokaż opcje
             if (chatState === 'IDLE') {
                 displayDefaultOptions();
             }

             toggleChatInput(true); // Odblokuj input
         }

         /** Blokuje lub odblokowuje pole input */
         function toggleChatInput(enabled) {
             const inputElement = document.getElementById('user-input');
             const sendButton = document.querySelector('#chat-input-area button');
             if (!inputElement || !sendButton) return;
             
             inputElement.disabled = !enabled;
             sendButton.disabled = !enabled;
             
             if (enabled) {
                 inputElement.focus();
                 startPlaceholderCarousel();
             } else {
                 if (placeholderInterval) clearInterval(placeholderInterval);
             }
         }

         /** Analizuje tekst użytkownika i generuje odpowiedź */
         function generateBotResponse(text) {
             const lowerText = text.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
             
             let detectedIntents = [];
             for (const [intent, keywords] of Object.entries(chatIntents)) {
                 if (keywords.some(keyword => lowerText.includes(keyword))) {
                     detectedIntents.push(intent);
                 }
             }
             
             // Obsługa podziękowań
             if (['dziekuje', 'dzieki', 'super'].some(k => lowerText.includes(k))) {
                 return { text: chatResponses.THANKS, newState: 'IDLE' };
             }

             // Jeśli nic nie wykryto
             if (detectedIntents.length === 0) {
                 // Jeśli stan był IDLE i nic nie wykryto
                 if (chatState === 'IDLE') {
                     return { text: chatResponses.DEFAULT, newState: 'IDLE' };
                 }
                 // Jeśli był inny stan (np. AWAITING_...), ale nie pasuje, wróć do IDLE
                 return { text: chatResponses.DEFAULT, newState: 'IDLE' };
             }
             
             // --- Logika Multi-Intent ---
             // Budujemy jedną odpowiedź z wielu intencji
             
             let responseMessages = [];
             let nextState = 'IDLE';

             // Priorytet dla powitania
             if (detectedIntents.includes('GREETING') && detectedIntents.length === 1) {
                 return { text: chatResponses.GREETING, newState: 'IDLE' };
             }
             
             // Usuwamy powitanie, jeśli występuje z innymi intencjami
             detectedIntents = detectedIntents.filter(i => i !== 'GREETING');

             // Sprawdź, czy produkt jest w pytaniu
             const productMatch = getProductsFromStorage().find(p => lowerText.includes(p.brand.toLowerCase()) || lowerText.includes(p.name.toLowerCase().split('(')[0].trim().toLowerCase()));

             for (const intent of detectedIntents) {
                 switch (intent) {
                     case 'ORDER_STATUS':
                         responseMessages.push(chatResponses.ORDER_STATUS);
                         nextState = 'AWAITING_ORDER_NUMBER'; // Ustaw stan oczekiwania
                         break;
                     case 'PRODUCT_INFO':
                         if (productMatch) {
                             responseMessages.push(`Perfuma <b>${productMatch.brand} ${productMatch.name}</b> jest dostępna w cenie **${productMatch.price} PLN**. Możesz ją znaleźć w <a onclick="showPage('kolekcja-page');">Kolekcji</a>.`);
                         } else {
                             responseMessages.push(chatResponses.PRODUCT_INFO_GENERIC);
                         }
                         break;
                     default:
                         // Dodaj inne standardowe odpowiedzi
                         if (chatResponses[intent] && !responseMessages.includes(chatResponses[intent])) {
                             responseMessages.push(chatResponses[intent]);
                         }
                 }
             }

             // Jeśli jedyną intencją było ORDER_STATUS, stan jest już ustawiony
             // Jeśli było ich więcej (np. status I zmiana adresu), bot zapyta o numer,
             // ale też udzieli odpowiedzi na drugie pytanie.
             
             return {
                 text: responseMessages.join('<br><br>'), // Łączy odpowiedzi
                 newState: nextState
             };
         }

         /** NOWA FUNKCJA: Pobiera status zamówienia z Supabase */
         async function fetchOrderStatus(orderId) {
             // Walidacja, czy Supabase jest skonfigurowane
             if (!supabase) {
                 return { 
                     text: 'Funkcja sprawdzania statusu jest chwilowo niedostępna. (Brak konfiguracji Supabase). Proszę o kontakt telefoniczny.', 
                     newState: 'IDLE' 
                 };
             }
             
             // Walidacja formatu ID (dostosuj do swoich potrzeb)
             const orderIdFormatted = orderId.trim();
             if (orderIdFormatted.length < 5) {
                 return { 
                     text: 'Podany numer zamówienia wydaje się niepoprawny. Spróbuj ponownie (np. 2025/10/29).', 
                     newState: 'AWAITING_ORDER_NUMBER' // Pozostań w stanie oczekiwania
                 };
             }
             
             try {
                 // Załóżmy, że Twoja tabela w Supabase nazywa się 'zamowienia' (użyj nazwy swojej tabeli)
                 // i ma kolumny 'id', 'date' oraz 'status'.
                 // WAŻNE: W Supabase nazwy tabel i kolumn są wrażliwe na wielkość liter.
                 const { data, error } = await supabase
                     .from('zamowienia') // <-- ZMIEŃ NA NAZWĘ SWOJEJ TABELI
                     .select('date, status') // <-- ZMIEŃ NA NAZWY SWOICH KOLUMN
                     .eq('id', orderIdFormatted) // Szukaj po ID
                     .single(); // Oczekujemy jednego wyniku

                 if (error || !data) {
                     console.error('Błąd Supabase:', error);
                     return { 
                         text: `Niestety, nie znalazłem w systemie zamówienia o numerze <b>${orderIdFormatted}</b>. Upewnij się, że numer jest poprawny i spróbuj ponownie.`, 
                         newState: 'IDLE' 
                     };
                 }

                 // Sukces!
                 return { 
                     text: `Mam! Zamówienie <b>${orderIdFormatted}</b> (złożone ${data.date}) ma obecnie status: <strong style="color:var(--color-accent-gold);">${data.status}</strong>.<br><br>Czy mogę pomóc w czymś jeszcze?`, 
                     newState: 'IDLE' 
                 };

             } catch (err) {
                 console.error('Błąd połączenia z Supabase:', err);
                 return { 
                     text: 'Wystąpił błąd podczas łączenia z bazą danych. Proszę, spróbuj ponownie za chwilę lub skontaktuj się z nami telefonicznie.', 
                     newState: 'IDLE' 
                 };
             }
         }
         
         // --- Karuzela placeholderów ---
         const popularQuestions = [
             "Wpisz: 'Cześć'",
             "Wpisz: 'Jaki jest status zamówienia?'",
             "Wpisz: 'Chcę zmienić miejsce odbioru'",
             "Wpisz: 'Cena Aventus'",
             "Wpisz: 'Kontakt z konsultantem'..."
         ];
         let placeholderIndex = 0;
         let placeholderInterval;

         function startPlaceholderCarousel() {
             const inputElement = document.getElementById('user-input');
             if (!inputElement || inputElement.disabled) return;
             if (placeholderInterval) {
                 clearInterval(placeholderInterval);
             }
             
             // Ustaw pierwszy od razu
             inputElement.placeholder = popularQuestions[placeholderIndex];
             
             placeholderInterval = setInterval(() => {
                 placeholderIndex = (placeholderIndex + 1) % popularQuestions.length;
                 
                 inputElement.style.transition = 'opacity 0.5s';
                 inputElement.style.opacity = '0.5';

                 setTimeout(() => {
                     inputElement.placeholder = popularQuestions[placeholderIndex];
                     inputElement.style.opacity = '1';
                 }, 500); 
             }, 3000); 
         }

         // === NOWE FUNKCJE: STRONA PRODUKTU I EDYCJA SPECYFIKACJI ===
         let currentDetailProductId = null;

         function showProductDetail(productId) {
             currentDetailProductId = productId;
             showPage('product-page');
             // renderProductDetail will be triggered via pageShow or directly:
             setTimeout(() => renderProductDetail(productId), 80);
         }

         function renderProductDetail(productId) {
             // === POPRAWKA BŁĘDU TYPÓW (Liczba vs Tekst) ===
             const p = getProductsFromStorage().find(x => String(x.id) === String(productId));
             
             if (!p) {
                 alert('Produkt nieznaleziony');
                 showPage('kolekcja-page');
                 return;
             }
             const imgEl = document.getElementById('detail-image');
             if (imgEl) {
                 if (p.images && p.images.length) imgEl.style.backgroundImage = `url(${p.images[0]})`;
                 else imgEl.style.backgroundImage = '';
             }
             document.getElementById('detail-brand').textContent = p.brand;
             document.getElementById('detail-name').textContent = p.name;
             document.getElementById('detail-price').textContent = p.price + ' PLN';
             document.getElementById('detail-description').innerHTML = p.description;

             const specsTable = document.getElementById('detail-specs');
             specsTable.innerHTML = '';
             if (p.specs && p.specs.length) {
                 p.specs.forEach(s => {
                     const row = document.createElement('tr');
                     row.innerHTML = `<td style="padding:6px; border-bottom:1px solid #EEE; width:35%;"><strong>${s.key}</strong></td><td style="padding:6px; border-bottom:1px solid #EEE;">${s.value}</td>`;
                     specsTable.appendChild(row);
                 });
             } else {
                 specsTable.innerHTML = '<tr><td colspan="2" style="padding:6px; color:#666;">Brak specyfikacji</td></tr>';
             }

             // pokaż przycisk edycji tylko dla admina
             const editBtn = document.getElementById('detail-edit-btn');
             if (editBtn) {
                 if (isCurrentUserAdmin()) {
                     editBtn.style.display = 'inline-block';
                 } else {
                     editBtn.style.display = 'none';
                 }
             }

             // ---- nowa logika miniaturek ----
             const thumbsContainer = document.getElementById('detail-thumbnails');
             if (thumbsContainer) {
                 thumbsContainer.innerHTML = '';
                 if (p.images && p.images.length) {
                     p.images.forEach((src, idx) => {
                         const t = document.createElement('div');
                         t.style.width = '64px';
                         t.style.height = '64px';
                         t.style.border = '1px solid #EEE';
                         t.style.overflow = 'hidden';
                         t.style.cursor = 'pointer';
                         t.style.borderRadius = '4px';
                         t.style.background = '#fff';
                         t.style.display = 'flex';
                         t.style.alignItems = 'center';
                         t.style.justifyContent = 'center';

                         const img = document.createElement('img');
                         img.src = src;
                         img.style.width = '100%';
                         img.style.height = '100%';
                         img.style.objectFit = 'cover';
                         img.alt = 'thumb';

                         t.appendChild(img);
                         t.onclick = () => {
                             const imgEl2 = document.getElementById('detail-image');
                             if (imgEl2) imgEl2.style.backgroundImage = `url(${src})`;
                         };
                         thumbsContainer.appendChild(t);
                     });
                 }
             }
         }

         function addToCartFromDetail() {
             if (!currentDetailProductId) return;
             addToCart(currentDetailProductId);
         }

         function editProductFromDetail() {
             if (!isCurrentUserAdmin()) {
                 alert('Tylko administrator może edytować produkt.');
                 return;
             }
             showPage('admin-page');
             setTimeout(() => {
                 showAdminContent('products');
                 setTimeout(() => {
                     populateAdminForm(currentDetailProductId);
                 }, 150);
             }, 150);
         }

         // === SPEC FIELDS FOR ADMIN FORM ===
         function addSpecField(key='', value='') {
             const list = document.getElementById('admin-specs-list');
             if(!list) return;
             const id = 'spec-' + Date.now() + '-' + Math.floor(Math.random()*1000);
             const div = document.createElement('div');
             div.style.display = 'flex';
             div.style.gap = '8px';
             div.style.marginBottom = '8px';
             div.id = id;
             div.innerHTML = `
                 <input type="text" placeholder="Klucz" value="${escapeHtmlAttr(key)}" data-spec-key style="flex:1; padding:8px; border:1px solid #CCC;">
                 <input type="text" placeholder="Wartość" value="${escapeHtmlAttr(value)}" data-spec-value style="flex:1; padding:8px; border:1px solid #CCC;">
                 <button type="button" onclick="removeSpecField('${id}')" style="background:#e74c3c;color:#fff;border:none;padding:8px 10px;cursor:pointer;">Usuń</button>
             `;
             list.appendChild(div);
         }

         function removeSpecField(rowId) {
             const el = document.getElementById(rowId);
             if (el) el.remove();
         }

         function readSpecsFromForm() {
             const list = document.getElementById('admin-specs-list');
             if (!list) return [];
             const rows = Array.from(list.querySelectorAll('div'));
             const specs = [];
             rows.forEach(row => {
                 const keyInput = row.querySelector('[data-spec-key]');
                 const valueInput = row.querySelector('[data-spec-value]');
                 if (keyInput && valueInput && keyInput.value.trim() !== '') {
                     specs.push({ key: keyInput.value.trim(), value: valueInput.value.trim() });
                 }
             });
             return specs;
         }

         function setSpecsToForm(specs) {
             const list = document.getElementById('admin-specs-list');
             if (!list) return;
             list.innerHTML = '';
             if (specs && specs.length) {
                 specs.forEach(s => addSpecField(s.key, s.value));
             }
         }

         // Small utility to safely insert values into attributes
         function escapeHtmlAttr(s) {
             if (s === undefined || s === null) return '';
             return String(s).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
         }

         // === OBSŁUGA ZDJĘĆ W PANELU ADMINA (localStorage jako dataURL) ===
         let adminImageData = []; // przechowuje dataURL obrazów aktualnie w formularzu (dodawanie/edycja)

         /** Wywołaj po wstrzyknięciu formularza admina: podłączy listener do input#admin-images */
         function setupAdminImageInput() {
             const input = document.getElementById('admin-images');
             if (!input) return;
             input.addEventListener('change', handleAdminImagesChange);
             // jeśli już istnieją obrazy w adminImageData (np. przy edycji), wyrenderuj je
             renderAdminImagePreviews();
         }

         /** Obsługa wyboru plików przez admina */
         function handleAdminImagesChange(event) {
             const files = Array.from(event.target.files || []);
             if (files.length === 0) return;

             const maxImages = 5;
             // jeśli dodanie plików przekroczy limit, obcinamy
            if (adminImageData.length + files.length > maxImages) {
                 alert(`Możesz dodać maksymalnie ${maxImages} zdjęć na produkt. Usuń niektóre lub dodaj mniej plików.`);
            }

             // ogranicz liczbę plików do wstawienia
             const allowedToAdd = files.slice(0, Math.max(0, maxImages - adminImageData.length));
             allowedToAdd.forEach(file => {
                 if (!file.type.startsWith('image/')) return;
                 const reader = new FileReader();
                 reader.onload = (e) => {
                    adminImageData.push(e.target.result); // dataURL
                    renderAdminImagePreviews();
                 };
                 reader.readAsDataURL(file);
            });

             // reset input, żeby ten sam plik mógł być wgrany ponownie po usunięciu
             event.target.value = '';
         }

         /** Renderuje miniatury obrazów w panelu admina z przyciskiem Usuń */
         function renderAdminImagePreviews() {
             const container = document.getElementById('admin-image-previews');
             if (!container) return;
             container.innerHTML = '';
             adminImageData.forEach((dataUrl, idx) => {
                 const wrap = document.createElement('div');
                 wrap.style.position = 'relative';
                 wrap.style.width = '80px';
                 wrap.style.height = '80px';
                 wrap.style.flex = '0 0 80px';
                 wrap.style.border = '1px solid #DDD';
                 wrap.style.overflow = 'hidden';
                 wrap.style.borderRadius = '4px';
                 wrap.style.background = '#fff';

                 const img = document.createElement('img');
                 img.src = dataUrl;
                 img.style.width = '100%';
                img.style.height = '100%';
                 img.style.objectFit = 'cover';
                 img.alt = 'preview';

                 const btn = document.createElement('button');
                 btn.textContent = '×';
                 btn.title = 'Usuń';
                 btn.style.position = 'absolute';
                 btn.style.top = '3px';
                 btn.style.right = '3px';
                 btn.style.background = 'rgba(0,0,0,0.6)';
                 btn.style.color = '#fff';
                 btn.style.border = 'none';
                 btn.style.width = '20px';
                 btn.style.height = '20px';
                 btn.style.borderRadius = '50%';
                 btn.style.cursor = 'pointer';
                 btn.onclick = () => removeAdminImage(idx);

                 wrap.appendChild(img);
                 wrap.appendChild(btn);
                 container.appendChild(wrap);
             });

             // informacja o limicie
             const info = document.createElement('div');
             info.style.fontSize = '0.8em';
             info.style.color = '#666';
              info.style.alignSelf = 'center';
             info.style.marginLeft = '6px';
             info.textContent = `${adminImageData.length} / 5`;
             container.appendChild(info);
         }

         /** Usuwa obraz z listy (admin) */
         function removeAdminImage(index) {
             if (index < 0 || index >= adminImageData.length) return;
             adminImageData.splice(index, 1);
             renderAdminImagePreviews();
         }

         // --- LOGIKA CHAT, INICJALIZACJA STRONY I ZDARZEŃ ---
         
         document.addEventListener('DOMContentLoaded', async () => { // <-- POPRAWKA ASYNC
             
            
             // === NOWOŚĆ: Sprawdzenie sesji Supabase przy starcie ===
             try {
                 const { data: { session } } = await supabase.auth.getSession();
                 
                 if (session && session.user) {
                     // Mamy aktywną sesję w Supabase! Zalogujmy użytkownika lokalnie.
                     const user = session.user;
                     // Sprawdzamy czy to admin
                     const isAdmin = user.email === 'odoris.pl@gmail.com'; 
                     
                     const currentUser = {
                         email: user.email,
                         username: user.user_metadata.username || (isAdmin ? 'Administrator' : user.email.split('@')[0]),
                         isAdmin: isAdmin,
                         id: user.id
                    };
                     // Zapisujemy info do naszej lokalnej sesji, aby reszta skryptów działała
                     localStorage.setItem(LS_SESSION_KEY, JSON.stringify(currentUser));
                 } else {
                     // Brak sesji w Supabase, upewnij się, że lokalna też jest czysta
                     localStorage.removeItem(LS_SESSION_KEY);
                 }
             } catch (e) {
                 console.error("Błąd przywracania sesji:", e);
                 localStorage.removeItem(LS_SESSION_KEY);
             }
             // === INICJALIZACJA BAZ ===
             await initializeProductStorage(); // <-- POPRAWKA AWAIT
             initializeOrderStorage(); 
             
             // Wstrzykiwanie Stopki
             const fullFooterContent = `
                 <div class="container footer-content">
                     <div class="footer-links">
                         <h4>Informacje</h4>
                         <a onclick="showPage('polityka-page');">Polityka Prywatności</a>
                         <a onclick="showPage('regulamin-page');">Regulamin Sprzedaży</a>
                         <a onclick="showPage('zwroty-page');">Zwroty i Reklamacje</a>
                     </div>
                     <div class="footer-links">
                         <h4>ODORIS</h4>
                         <a onclick="showPage('kolekcja-page');">Katalog Zapachów</a>
                         <a onclick="showPage('onas-page');">O Naszej Misji</a>
                         <a onclick="showPage('pomoc-page');">Wsparcie i FAQ</a>
                         <a onclick="showPage('konto-page');">Moje Konto Klienta</a>
                     </div>
                     <div class="footer-contact">
                         <h4>&iquest; Masz Pytanie?</h4>
                         <strong class="gold-text">TELEFON:</strong> <a href="tel:532116720">532 116 720</a>
                         <strong class="gold-text">E-MAIL:</strong> <a href="mailto:odoris.pl@gmail.com">odoris.pl@gmail.com</a>
                     </div>
                     <div class="copyright">
                         <p>&copy; 2025 ODORIS. Wszelkie prawa zastrzeżone.</p>
                </div>
                 </div>
             `;
             document.querySelectorAll('footer').forEach(footer => {
                 footer.innerHTML = fullFooterContent;
             });
             
             applyFilters(); // Uruchom po pobraniu danych

             document.addEventListener('pageShow', (e) => {

                 // --- Kod dla Chatbota na stronie Pomocy ---
                if (e.detail.pageId === 'pomoc-page') {
                     chatState = 'IDLE'; // Resetuj stan przy każdym otwarciu
                     document.getElementById('chat-history').innerHTML = '<div class="bot-message">Witaj! Jestem Bot Wsparcia. Jak mogę Ci pomóc?</div>'; // Wiadomość powitalna
                     displayDefaultOptions(); // Pokaż przyciski
                     toggleChatInput(true); // Odblokuj input
                     
                     const userInputEl = document.getElementById('user-input');
                     if (userInputEl && !userInputEl.dataset.listenerAttached) { // Zapobiegaj wielokrotnemu dodaniu listenera
                         userInputEl.addEventListener('keydown', function(event) {
                             if (event.key === 'Enter') {
                                 event.preventDefault();
                                 sendChatMessage();
                     }
                         });
                         userInputEl.dataset.listenerAttached = 'true';
                     }
                 }
                 
                 // --- Kod dla Strony Produktu (żeby linki działały) ---
                if (e.detail.pageId === 'product-page') {
                     // ensure details render if navigated directly
                     if (currentDetailProductId) renderProductDetail(currentDetailProductId);
                 }
             });

             showPage('landing-page');

             document.querySelectorAll('#filter-sidebar input[type="checkbox"]').forEach(checkbox => {
                 checkbox.addEventListener('change', applyFilters);
             });
             const sortByElement = document.getElementById('sort-by');
             if(sortByElement) sortByElement.addEventListener('change', applyFilters);

             updateSideMenu();
             
             // ### KROK 3: INICJALIZACJA LICZNIKA PRZY STARCIE ###
            updateCartCounters();
     // --- Logika akordeonu filtrów ---
     const filterToggles = document.querySelectorAll('.filter-group-toggle');
     filterToggles.forEach(toggle => {
         toggle.addEventListener('click', () => {
             // Znajdź rodzica .filter-group
             const group = toggle.parentElement;
             if (group && group.classList.contains('filter-group')) {
                 // Przełącz klasę .active
                 group.classList.toggle('active');
             }
         });
     });
         });
      </script>
</body>
</html>
